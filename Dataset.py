import psycopg2
import pandas as pd
import json

def connect_postgres():
    with open('C:/Users/camil/OneDrive/Documents/GitHub/soccer_project/db_config.json') as f:
        dbfile = json.load(f)
    connection = psycopg2.connect(
        database=dbfile["database"],
        user=dbfile["user"],
        password=dbfile["password"],
        host="localhost",
        port=5432
    )
    return connection
    print("Database connection ok")

def transform_dataset():
    players_df = pd.read_csv("C:/Prevalidador_Requisitos_Saldo_a_favor_Renta_v3.1.0-20/2021-2022 Football Player Stats.csv", sep=";", encoding="ISO-8859-1")
    nombre="playerstats_modificado.csv"
    players_df.to_csv(nombre,index=False,sep=",")

def create_table():
    connection = connect_postgres()
    cursor = connection.cursor()
    cursor.execute("""CREATE TABLE IF NOT EXISTS playerstats (
        rk integer primary key,
        player varchar(255),
        nation varchar(255),
        position varchar(255),
        team varchar(255),
        league varchar(255),
        age float,
        born integer,
        mp integer,
        starts integer,
        min integer,
        S90 float,
        goals float,
        shots float,
        sot float,
        sotPORCENT float,
        gsh float,
        gsot float,
        shodist float,
        shofk float,
        shopk float,
        pkatt float,
        pastotcmp float,
        pastoatt float,
        pastotcmpPORCENT float,
        pastotdist float,
        pastotprgdist float,
        passhocmp float,
        passhoatt float,
        passhocmpPORCENT float,
        pasmedcmp float,
        pasmedatt float,
        pasmedcmpPORCENT float,
        pasloncmp float,
        paslonatt float,
        pasloncmpPORCENT float,
        assists float,
        passass float,
        pas3rd float,
        ppa float,
        crspa float,
        pasprog float,
        pasatt float,
        paslive float,
        pasdead float,
        pasfk float,
        tb float,
        paspress float,
        sw float,
        pascrs float,
        ck float,
        ckin float,
        ckout float,
        ckstr float,
        pasground float,
        paslow float,
        pashigh float,
        paswleft float,
        paswright float,
        paswhead float,
        ti float,
        paswother float,
        pascmp float,
        pasoff float,
        pasout float,
        pasint float,
        pasblocks float,
        sca float,
        scapasslive float,
        scapassdead float,
        scadrib float,
        scash float,
        scafld float,
        scadef float,
        gca float,
        gcapasslive float,
        gcapassdead float,
        gcadrib float,
        gcash float,
        gcafld float,
        gcadef float,
        tkl float,
        tklwon float,
        tkldef3rd float,
        tklmid3rd float,
        tklatt3rd float,
        tkldri float,
        tkldriatt float,
        tkldriPORCENT float,
        tkldripast float,
        press float,
        pressucc float,
        pressPORCENT float,
        presdef3rd float,
        presmid3rd float,
        presatt3rd float,
        blocks float,
        blksh float,
        blkshsv float,
        blkpass float,
        int float,
        tklmasint float,
        clr float,
        err float,
        touches float,
        toudefpen float,
        toudef3rd float,
        toumid3rd float,
        touatt3rd float,
        touattpen float,
        toulive float,
        drisucc float,
        driatt float,
        drisuccPORCENT float,
        dripast float,
        drimegs float,
        carries float,
        cartotdist float,
        carprgdist float,
        carprog float,
        car3rd float,
        cpa float,
        carmis float,
        cardis float,
        rectarg float,
        rec float,
        recPORCENT float,
        recprog float,
        crdy float,
        crdr float,
        crdy2 float,
        fls float,
        fld float,
        off float,
        crs float,
        tklw float,
        pkwon float,
        pkcon float,
        og float,
        recov float,
        aerwon float,
        aerlost float,
        aerwonPORCENT float
        
    )""")

    

    connection.commit()
    print("tabla creada")

    copy = """COPY playerstats(
        rk,
        player,
        nation,
        position,
        team,
        league,
        age,
        born,
        mp,
        starts,
        min,
        S90,
        goals,
        shots,
        sot,
        sotPORCENT,
        gsh,
        gsot,
        shodist,
        shofk,
        shopk,
        pkatt,
        pastotcmp,
        pastoatt,
        pastotcmpPORCENT,
        pastotdist,
        pastotprgdist,
        passhocmp,
        passhoatt,
        passhocmpPORCENT,
        pasmedcmp,
        pasmedatt,
        pasmedcmpPORCENT,
        pasloncmp,
        paslonatt,
        pasloncmpPORCENT,
        assists,
        passass,
        pas3rd,
        ppa,
        crspa,
        pasprog,
        pasatt,
        paslive,
        pasdead,
        pasfk,
        tb,
        paspress,
        sw,
        pascrs,
        ck,
        ckin,
        ckout,
        ckstr,
        pasground,
        paslow,
        pashigh,
        paswleft,
        paswright,
        paswhead,
        ti,
        paswother,
        pascmp,
        pasoff,
        pasout,
        pasint,
        pasblocks,
        sca,
        scapasslive,
        scapassdead,
        scadrib,
        scash,
        scafld,
        scadef,
        gca,
        gcapasslive,
        gcapassdead,
        gcadrib,
        gcash,
        gcafld,
        gcadef,
        tkl,
        tklwon,
        tkldef3rd,
        tklmid3rd,
        tklatt3rd,
        tkldri,
        tkldriatt,
        tkldriPORCENT,
        tkldripast,
        press,
        pressucc,
        pressPORCENT,
        presdef3rd,
        presmid3rd,
        presatt3rd,
        blocks,
        blksh,
        blkshsv,
        blkpass,
        int,
        tklmasint,
        clr,
        err,
        touches,
        toudefpen,
        toudef3rd,
        toumid3rd,
        touatt3rd,
        touattpen,
        toulive,
        drisucc,
        driatt,
        drisuccPORCENT,
        dripast,
        drimegs,
        carries,
        cartotdist,
        carprgdist,
        carprog,
        car3rd,
        cpa,
        carmis,
        cardis,
        rectarg,
        rec,
        recPORCENT,
        recprog,
        crdy,
        crdr,
        crdy2,
        fls,
        fld,
        off,
        crs,
        tklw,
        pkwon,
        pkcon,
        og,
        recov,
        aerwon,
        aerlost,
        aerwonPORCENT
        
    )
    FROM 'C:/Prevalidador_Requisitos_Saldo_a_favor_Renta_v3.1.0-20/playerstats_modificado.csv' DELIMITER ',' CSV HEADER
    """
    cursor.execute(copy)
    connection.commit()
    print("tabla importada")
    
    cursor.close()
    connection.close()





def delete_columns():
    connection = connect_postgres()
    cursor = connection.cursor()
    cursor.execute("""ALTER TABLE playerstats DROP COLUMN pastoatt, 
                   DROP pascmp, 
                   DROP gcapasslive, 
                   DROP gcapassdead, 
                   DROP scapasslive, 
                   DROP scapassdead, 
                   DROP pascrs, 
                   DROP born, 
                   DROP gsot, 
                   DROP gcadrib, 
                   DROP scadrib, 
                   DROP tklwon, 
                   DROP tklw, 
                   DROP tb, 
                   DROP recov, 
                   DROP shofk, 
                   DROP blkpass, 
                   DROP pkwon,
                   DROP paslive,
                   DROP pasdead,
                   DROP ckout,
                   DROP ckstr,
                   DROP paslow,
                   DROP pashigh,
                   DROP paswhead


                   ;""")
    connection.commit()
    print("Datos borrados")

if __name__ == "__main__":
    connection = connect_postgres()
    create_table()